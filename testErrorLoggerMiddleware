const app = require('express')();
const axios = require('axios')
const PORT = 3000;

const ErrorLoggerMiddleware = async (req, res, next) => {
    try {
        console.log(111111)
        await next(); // Chỗ này sẽ console.log(22222) để test đúng thứ tự chưa
        console.log(333333)
    } catch (e) {
        // Log error
        console.log(444444, e);
    }
}

app.use(ErrorLoggerMiddleware);

app.get('/', async (req, res, next) => {
    // Đoạn này test xem Catch của hàm ErrorLoggerMiddleware có bắt được lỗi không => Result: không được
    // console.log(222222)
    // throw new Error('Loi oke ne');

    // Đoạn này test xem Catch ở đây có bắt được không => Result: Bắt được
    try {
        console.log(222222)
        throw new Error('Loi oke ne');
    } catch (e) {
        console.log("tttTTT", e)
    }
});

app.get('/test', async (req, res, next) => {
    // Đoạn này test xem có chạy theo đúng thứ tự hay không => Result: Chạy đúng thứ tự nhưng khi sửa lại url 'https://dog.ceo/api/breeds/list/all' -> 
    // 'https://dog.ceo/api/breeds/list/all123123' để xuất hiện lỗi thì không vào catch của hàm ErrorLoggerMiddleware
    try {
        const data = await axios.get('https://dog.ceo/api/breeds/list/all').data;
        res.send({data});
        console.log(2222222)
    } catch (e) {
        console.log("zzzzzzzzzzzzzzzz", e)
    }
})

app.use(function(error, req, res, next) {
    res.json({ message: error.message });
});

app.listen(PORT, () => {
    console.log('Server is running at PORT',PORT);
});
